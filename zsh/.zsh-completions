# Initialize command-line autocompletion
#
# - `autoload`: Tells zsh to load the function the first time it's called,
#    rather than loading it immediately. This helps keep the shell startup fast.
# - `-U`: Use the function without aliases.
#   - This means that when the function (e.g., compinit) is autoloaded, aliases
#     defined in your shell won't be expanded inside that function.
#   - It ensures that the behavior of the autoloaded function remains clean and
#     consistent, unaffected by any shell aliases you may have defined.
# - `-z`: Indicates this is for zsh functions (not needed if already in zsh, but
#   harmless).
#   - It tells Zsh that the autoloaded function is written specifically for Zsh,
#     not for another shell like Bash or ksh.
#   - Technically, it ensures the function is interpreted in Zsh's native
#     function format (e.g., using Zsh-style comments and metadata).
autoload -Uz compinit

# Smarter completion initialization
if [ "$(date +'%j')" != "$(stat -f '%Sm' -t '%j' ~/.zcompdump 2>/dev/null)" ]; then
    # `compinit`: a function that actually initializes zsh's powerful completion
    # system.
    # - `-u`: tells compinit to skip security checks for world-writable
    #   directories in your $fpath. Normally, zsh will complain or refuse to
    #   initialize completion if it detects potentially insecure permissions. It
    #   is sometimes necessary in shared or non-standard environments.
    compinit
else
    # `-C`: Clears the cache of dumped completion functions (i.e., don’t use the
    # .zcompdump file)
    #
    #     What is `.zcompdump?`
    #
    #     When you run `compinit`, it normally scans all available completion
    #     functions and creates a cache (usually in a file like `~/.zcompdump`)
    #     to speed up future shell startups.
    #
    #     Without a cache, `compinit` has to scan every function directory every
    #     time.
    #
    #     With the cache (`.zcompdump`), it just loads the preprocessed list -
    #     much faster.
    compinit -C
fi


# fpath=(~/.zsh/completion $fpath)
# fpath=(~/.zsh/completion/cmake $fpath)
# fpath=(~/.zsh/completion/docker $fpath)
# fpath=(~/.zsh/completion/rust $fpath)
# fpath=(~/.zsh/completion/curl $fpath)


# Configure the order in which Zsh's completion engine tries different
# completion strategies (called "completers") when you hit Tab.
#
# When you press Tab, Zsh will try:
#
# - `_extensions`: Try adding file extensions (like .sh, .py, etc.)
# - `_complete`: The standard, exact match completion (commands, filenames,
#   options, etc.)
# - `_approximate`: Fuzzy/approximate matching — e.g., fix typos like gti -> git
# - `_list`: Just list all possible completions
#     `zstyle`
#         This is Zsh's configuration system for modules like completion,
#         prompts, and more.
#     `':completion:*'`
#         The context you're configuring - this tells Zsh to apply the style to
#         all completion operations (`*` is a wildcard).
#     `completer` (??)
#          This is the style key being set - it defines which completion
#          functions to use, and in what order.
#     `_extensions`, `_complete`, `_approximate`, `_list`
#          These are completion functions ("completers") that Zsh will try in
#          sequence when doing completion.
zstyle ':completion:*'  completer       _extensions _complete _approximate _list

zstyle ':completion:*'  use-cache       on
zstyle ':completion:*'  cache-path      "$XDG_CACHE_HOME/zsh/.zcompcache"
zstyle ':completion:*'  menu            select
zstyle ':completion:*'  rehash          true
zstyle ':completion:*'  matcher-list    '' \
                                        '+m:{[:lower:]}={[:upper:]}' \
                                        '+m:{[:upper:]}={[:lower:]}' \
                                        '+m:{_-}={-_}' \
                                        'r:|[._-]=* r:|=*' \
                                        'l:|=* r:|=*'

zstyle      ':completion:*:*:make:*'                tag-order      'targets'
zstyle -e   ':completion:*'                         special-dirs   '[[ $PREFIX = (../)#(..) ]] && reply=(..)'
zstyle      ':completion:*:complete:(cd|pushd):*'   tag-order      'local-directories named-directories'

# zstyle ':completion:*' group-name ''
# zstyle ':completion:*:descriptions' format %F{green}%B%{$__USER[ITALIC_ON]%}--- %d \
#                                            ---%{$__ALI[ITALIC_OFF]%}%b%f
# zstyle ':completion:*:*:*:*:corrections' format '%F{yellow}!- %d (errors: %e) -!%f'
# zstyle ':completion:*:messages' format ' %F{purple} -- %d --%f'
# zstyle ':completion:*:warnings' format ' %F{red}-- no matches found --%f'
# zstyle ':completion:*:*:-command-:*:*' group-order alias builtins functions commands
#
# zstyle ':completion:*:*:v:*' file-patterns \
#     '^(__pycache__|*.egg-info|*.dSYM|.cache|main|build|venv|*.o|.pytest_cache|.git|*.pdf):directories'
# zstyle ':completion:*:*:vi:*' file-patterns  \
#     '^(__pycache__|*.egg-info|*.dSYM|.cache|main|build|venv|*.o|.pytest_cache|.git|*.pdf):directories'
# zstyle ':completion:*:*:vim:*' file-patterns \
#     '^(__pycache__|*.egg-info|*.dSYM|.cache|main|build|venv|*.o|.pytest_cache|.git|*.pdf):directories'
# zstyle ':completion:*:*:nvim:*' file-patterns \
#     '^(__pycache__|*.egg-info|*.dSYM|.cache|main|build|venv|*.o|.pytest_cache|.git|*.pdf):directories'
# zstyle ':completion:*:*:python:*' file-patterns \
#     '^(__pycache__|*.egg-info|build|venv|*.o|.pytest_cache|.git):directories'
#
# unset '_comps[source]'
#
# _comp_options+=(globdots)
#
